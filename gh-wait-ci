#!/usr/bin/env bash
set -euo pipefail

# Wait for GitHub Actions CI to complete and report results
# Usage: wait-ci.sh [run-id]
# If no run-id provided, finds the run for the current commit

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

error() { echo -e "${RED}ERROR: $*${NC}" >&2; }
info() { echo -e "${BLUE}$*${NC}"; }
success() { echo -e "${GREEN}$*${NC}"; }
warn() { echo -e "${YELLOW}$*${NC}"; }

check_git_repo() {
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        error "Not in a git repository"
        exit 1
    fi
}

check_pushed() {
    local unpushed
    unpushed=$(git log @{u}..HEAD --oneline 2>/dev/null || echo "")
    if [[ -n "$unpushed" ]]; then
        warn "Unpushed commits detected:"
        echo "$unpushed"
        error "Push your changes first before waiting for CI"
        exit 1
    fi
}

get_context() {
    COMMIT=$(git rev-parse HEAD)
    SHORT_COMMIT=$(git rev-parse --short HEAD)
    BRANCH=$(git branch --show-current)
    REPO=$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "")

    if [[ -z "$REPO" ]]; then
        error "Could not determine GitHub repository"
        exit 1
    fi

    COMMIT_URL="https://github.com/$REPO/commit/$COMMIT"
}

print_context() {
    info "Repository: $REPO"
    info "Branch: $BRANCH"
    info "Commit: $SHORT_COMMIT"
    echo ""
}

get_pr_info() {
    PR_URL=""
    PR_NUM=""
    local pr_json
    if pr_json=$(gh pr view --json number,url 2>/dev/null); then
        PR_NUM=$(echo "$pr_json" | jq -r .number)
        PR_URL=$(echo "$pr_json" | jq -r .url)
        info "PR: #$PR_NUM"
        echo "  $PR_URL"
    fi
    info "Commit URL:"
    echo "  $COMMIT_URL"
    echo ""
}

find_run() {
    local run_id="${1:-}"

    if [[ -n "$run_id" ]]; then
        RUN_ID="$run_id"
        RUN_URL=$(gh run view "$RUN_ID" --json url -q .url 2>/dev/null || echo "")
        RUN_NAME=$(gh run view "$RUN_ID" --json name -q .name 2>/dev/null || echo "Run $RUN_ID")
        info "Watching specified run: $RUN_NAME (ID: $RUN_ID)"
        return
    fi

    info "Finding workflow run for commit $SHORT_COMMIT..."

    local runs_json run_count
    for i in {1..5}; do
        runs_json=$(gh run list --commit "$COMMIT" --json databaseId,status,conclusion,url,name,event --limit 10 2>/dev/null || echo "[]")
        run_count=$(echo "$runs_json" | jq 'length')

        if [[ "$run_count" -gt 0 ]]; then
            break
        fi

        if [[ $i -lt 5 ]]; then
            warn "No runs found yet, waiting 5 seconds... (attempt $i/5)"
            sleep 5
        fi
    done

    if [[ "$run_count" -eq 0 ]]; then
        error "No workflow runs found for commit $SHORT_COMMIT"
        exit 1
    fi

    info "Found $run_count workflow run(s):"
    echo "$runs_json" | jq -r '.[] | "  [\(.databaseId)] \(.name) - \(.status) \(.conclusion // "")"'
    echo ""

    RUN_ID=$(echo "$runs_json" | jq -r '.[0].databaseId')
    RUN_NAME=$(echo "$runs_json" | jq -r '.[0].name')
    RUN_URL=$(echo "$runs_json" | jq -r '.[0].url')

    info "Watching run: $RUN_NAME (ID: $RUN_ID)"
}

wait_for_run() {
    echo "  $RUN_URL"
    echo ""
    info "Waiting for CI to complete..."
    echo ""

    if gh run watch "$RUN_ID" --exit-status; then
        CONCLUSION="success"
    else
        CONCLUSION="failure"
    fi
    echo ""
}

show_results() {
    local result_json final_conclusion
    result_json=$(gh run view "$RUN_ID" --json conclusion,jobs,url)
    final_conclusion=$(echo "$result_json" | jq -r .conclusion)
    RUN_URL=$(echo "$result_json" | jq -r .url)

    echo "════════════════════════════════════════════════════════════════"
    if [[ "$final_conclusion" == "success" ]]; then
        success "✓ CI PASSED"
    else
        error "✗ CI FAILED"
    fi
    echo "════════════════════════════════════════════════════════════════"
    echo ""

    info "Jobs:"
    echo "$result_json" | jq -r '.jobs[] | "  [\(.conclusion // .status)] \(.name)"'
    echo ""

    info "Links:"
    echo "  Run: $RUN_URL"
    echo "  Commit: $COMMIT_URL"
    [[ -n "$PR_URL" ]] && echo "  PR: $PR_URL"
    echo ""

    if [[ "$final_conclusion" != "success" ]]; then
        warn "Failed job logs:"
        echo ""
        gh run view "$RUN_ID" --log-failed 2>/dev/null || true
    fi

    [[ "$final_conclusion" == "success" ]]
}

main() {
    check_git_repo
    check_pushed
    get_context
    print_context
    get_pr_info
    find_run "${1:-}"
    wait_for_run
    show_results
}

main "$@"
